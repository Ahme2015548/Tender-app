import{u as ae,a as oe,r as l,b as le,c as ne,d as ie,j as t,I as z,P as ce,C as de,T as w,s as ge,t as me,f as ue,g as G,S as fe}from"./index-1759246972099-Cj1vZ7mq.js";const be=({refreshTrigger:V,searchTerm:E})=>{const j=ae(),{hasPerm:he}=oe();console.log("LostTendersList is rendering");const[f,y]=l.useState([]),[L,C]=l.useState(!0),[h,P]=l.useState(null),[q,xe]=l.useState(""),g=E!==void 0?E:q,[x,v]=l.useState([]),[D,p]=l.useState(!1),[d,W]=l.useState({}),[u,F]=l.useState({}),{logActivity:R,getCurrentUser:O}=le(),{alertConfig:m,closeAlert:H,showSuccess:A,showError:N,showConfirm:k}=ne(),{currentPage:$,totalPages:J,paginatedItems:K,handlePageChange:Q,resetPage:U,totalItems:X,itemsPerPage:B}=ie(x,30);console.log("LostTendersList state:",{tendersCount:f.length,loading:L,error:h});const S=async e=>{try{if(d[e])return d[e];console.log("💰 [LOST-TENDERS] Fetching final price from tender study for:",e);const r=await me.getTenderStudy(e);let s=0;if(r.success&&r.data&&r.data.profitCalculation)s=parseFloat(r.data.profitCalculation.finalPrice||0),console.log("✅ [LOST-TENDERS] Found final price from study:",s,"for tender:",e);else{console.log("⚠️ [LOST-TENDERS] No study data found, trying tender items as fallback...");try{const a=await ue.getAllTenderItems(e);a&&a.length>0&&(s=a.reduce((n,i)=>{const o=i.totalPrice||i.quantity*i.unitPrice||0;return n+o},0),console.log("📋 [LOST-TENDERS] Fallback calculation from items:",s))}catch(a){console.error("❌ [LOST-TENDERS] Items fallback failed:",a)}}return console.log("✅ [LOST-TENDERS] Final price determined:",s,"for tender:",e),W(a=>({...a,[e]:s})),s}catch(r){return console.error("❌ [LOST-TENDERS] Error fetching final price from study:",r),0}},M=async e=>{try{if(u[e]!==void 0)return u[e];console.log("💰 [LOST-TENDERS] Fetching lowest price from tender result for:",e);const r=await G.getTenderResultStats(e);let s=0;return r&&r.lowestPrice?(s=parseFloat(r.lowestPrice||0),console.log("✅ [LOST-TENDERS] Found lowest price from result stats:",s,"for tender:",e)):console.log("⚠️ [LOST-TENDERS] No result stats found for tender:",e),console.log("✅ [LOST-TENDERS] Lowest price determined:",s,"for tender:",e),F(a=>({...a,[e]:s})),s}catch(r){return console.error("❌ [LOST-TENDERS] Error fetching lowest price from result stats:",r),0}},b=async()=>{try{C(!0),P(null),console.log("Loading lost tenders...");const e=await w.getLostTenders();console.log("Lost tenders loaded:",e.length),e.length>0&&(console.log("=== FIRST LOST TENDER COMPLETE DATA ==="),console.log("Full tender object:",e[0]),console.log("All fields:",Object.keys(e[0])),console.log("Date fields specifically:"),Object.keys(e[0]).forEach(s=>{const a=e[0][s];a&&(s.toLowerCase().includes("date")||s.toLowerCase().includes("deadline")||s.toLowerCase().includes("انتهاء")||s.toLowerCase().includes("موعد"))&&(console.log(`  ${s}:`,a,typeof a),a&&typeof a=="object"&&a.seconds&&console.log("    Firestore timestamp - converts to:",new Date(a.seconds*1e3)))})),console.log("🔍 DEBUGGING: Before sorting, first 3 lost tenders:",e.slice(0,3).map(s=>({title:s.title,id:s.id,createdAt:s.createdAt,createdAtType:typeof s.createdAt,createdAtValue:s.createdAt instanceof Date?s.createdAt.toISOString():s.createdAt})));const r=ge(e);console.log("🔍 DEBUGGING: After sorting, first 3 lost tenders:",r.slice(0,3).map(s=>({title:s.title,id:s.id,createdAt:s.createdAt,createdAtType:typeof s.createdAt,createdAtValue:s.createdAt instanceof Date?s.createdAt.toISOString():s.createdAt}))),console.log("✅ Applied global sorting - newest lost tenders first:",r.length),y(r),r.forEach(s=>{s.id&&(S(s.id),M(s.id))})}catch(e){console.error("Error loading lost tenders:",e),P(e.message||"فشل في تحميل المناقصات الخاسرة")}finally{C(!1)}},Y=({tenderId:e})=>{const[r,s]=l.useState(0),[a,n]=l.useState(!0);return l.useEffect(()=>{const i=async()=>{n(!0);try{const o=await S(e);s(o)}catch(o){console.error("Error loading total for tender:",e,o)}finally{n(!1)}};e&&(d[e]!==void 0?(s(d[e]),n(!1)):i())},[e,d]),a?t.jsxs("span",{className:"badge bg-secondary text-white",children:[t.jsx("i",{className:"bi bi-hourglass-split me-1"}),"يحسب..."]}):t.jsxs("span",{className:"badge bg-success text-white",children:[r.toLocaleString("en-US",{minimumFractionDigits:1,maximumFractionDigits:1})," ر.س"]})},Z=({tenderId:e})=>{const[r,s]=l.useState(0),[a,n]=l.useState(!0);return l.useEffect(()=>{e&&(async()=>{n(!0);try{console.log("🔄 [LOST-TENDERS] Force fetching fresh lowest price for:",e);const o=await G.getTenderResultStats(e),c=(o==null?void 0:o.lowestPrice)||0;console.log("✅ [LOST-TENDERS] Fresh lowest price:",c,"for tender:",e),s(c),F(T=>({...T,[e]:c}))}catch(o){console.error("❌ [LOST-TENDERS] Error loading lowest price for tender:",e,o)}finally{n(!1)}})()},[e]),a?t.jsxs("span",{className:"badge bg-secondary text-white",children:[t.jsx("i",{className:"bi bi-hourglass-split me-1"}),"يحسب..."]}):r>0?t.jsxs("span",{className:"badge text-white",style:{fontSize:"11px",padding:"4px 8px",backgroundColor:"#6c757d"},children:[r.toLocaleString("en-US",{minimumFractionDigits:1,maximumFractionDigits:1})," ر.س"]}):t.jsx("span",{className:"badge bg-secondary text-white",style:{fontSize:"11px",padding:"4px 8px"},children:"غير محدد"})},_=({tenderId:e})=>{const[r,s]=l.useState(null),[a,n]=l.useState(!0);if(l.useEffect(()=>{const i=async()=>{n(!0);try{const[o,c]=await Promise.all([S(e),M(e)]);if(console.log("📊 [PRICE-DIFFERENCE] Our price:",o,"Lowest price:",c,"for tender:",e),o>0&&c>0){const T=o-c;s(T),console.log("💰 [PRICE-DIFFERENCE] Calculated difference:",T,"for tender:",e)}else s(null),console.log("⚠️ [PRICE-DIFFERENCE] Missing price data for tender:",e)}catch(o){console.error("❌ [PRICE-DIFFERENCE] Error calculating price difference:",o),s(null)}finally{n(!1)}};if(e)if(d[e]!==void 0&&u[e]!==void 0){const o=d[e],c=u[e];o>0&&c>0?s(o-c):s(null),n(!1)}else i()},[e,d,u]),a)return t.jsxs("span",{className:"badge bg-secondary text-white",children:[t.jsx("i",{className:"bi bi-hourglass-split me-1"}),"يحسب..."]});if(r!==null){const i=r>0;return t.jsxs("span",{className:"badge bg-primary text-white",style:{fontSize:"11px",padding:"4px 8px"},children:[i&&"+",r.toLocaleString("en-US",{minimumFractionDigits:1,maximumFractionDigits:1})," ر.س"]})}else return t.jsx("span",{className:"badge bg-secondary text-white",style:{fontSize:"11px",padding:"4px 8px"},children:"غير متوفر"})};l.useEffect(()=>{b()},[V]),l.useEffect(()=>{const e=setInterval(()=>{y(r=>[...r])},6e4);return()=>clearInterval(e)},[]),l.useEffect(()=>{if(g.trim()){const e=f.filter(r=>{var s,a,n,i;return((s=r.title)==null?void 0:s.toLowerCase().includes(g.toLowerCase()))||((a=r.referenceNumber)==null?void 0:a.toLowerCase().includes(g.toLowerCase()))||((n=r.entity)==null?void 0:n.toLowerCase().includes(g.toLowerCase()))||((i=r.description)==null?void 0:i.toLowerCase().includes(g.toLowerCase()))});v(e)}else v(f);U()},[g,f,U]);const I=e=>{k(`هل أنت متأكد من نقل هذه المناقصة إلى صفحة متابعة المناقصات؟

${e.title}

سيتم إضافتها مباشرة لصفحة التتبع وليس لقائمة المناقصات`,()=>ee(e),"تأكيد نقل للتتبع")},ee=async e=>{try{p(!0);const r="active",s=!0;console.log("🎯 [BULLETPROOF-LOST] Force restoring to tracking page for:",e.id),await w.moveFromLostTendersAbsolute(e.id,r,s);const a=O();R("task",`${a.name} نقل مناقصة من الخاسرة إلى التتبع`,`تم نقل مناقصة: ${e.title}`),b(),A(`تم نقل المناقصة إلى التتبع: ${e.title}`,"المناقصة متاحة الآن في صفحة متابعة المناقصات"),console.log("🎯 [BULLETPROOF-LOST] Force restoration to tracking completed successfully")}catch(r){console.error("❌ [BULLETPROOF-LOST] Error in force restoration to tracking:",r),N(`فشل في النقل إلى التتبع: ${r.message}`,"خطأ في النقل")}finally{p(!1)}},te=e=>{k(`هل أنت متأكد من الحذف النهائي لهذه المناقصة؟ لن يمكن استعادتها مرة أخرى.

${e.title}`,()=>se(e),"تحذير: حذف نهائي")},se=async e=>{try{p(!0),await fe.moveToTrash(e,"tenders"),await w.deleteTender(e.id);const r=O();R("task",`${r.name} حذف مناقصة خاسرة نهائياً`,`تم الحذف النهائي لمناقصة: ${e.title}`),b(),A(`تم حذف المناقصة نهائياً: ${e.title}`,"تم الحذف النهائي")}catch(r){console.error("Error permanently deleting tender:",r),N(`فشل في حذف المناقصة نهائياً: ${r.message}`,"خطأ في الحذف النهائي")}finally{p(!1)}},re=e=>t.jsx("span",{className:"badge bg-danger text-white",children:"خاسرة"});return L?(console.log("LostTendersList: Showing loading state"),t.jsx("div",{className:"card shadow-sm",children:t.jsxs("div",{className:"card-body text-center py-5",children:[t.jsx("div",{className:"spinner-border text-primary",role:"status",children:t.jsx("span",{className:"visually-hidden",children:"جار التحميل..."})}),t.jsx("p",{className:"mt-3 text-muted",children:"جار تحميل المناقصات الخاسرة..."})]})})):h?(console.log("LostTendersList: Showing error state:",h),t.jsx("div",{className:"card shadow-sm",children:t.jsxs("div",{className:"card-body text-center py-5",children:[t.jsx("div",{className:"text-danger mb-3",children:t.jsx("i",{className:"bi bi-exclamation-triangle fs-1"})}),t.jsx("h5",{className:"text-danger",children:"حدث خطأ"}),t.jsx("p",{className:"text-muted",children:h}),t.jsx("div",{className:"d-flex gap-2 justify-content-center",children:t.jsxs("button",{className:"btn btn-primary",onClick:b,children:[t.jsx("i",{className:"bi bi-arrow-clockwise me-2"}),"إعادة تحميل البيانات"]})})]})})):(console.log("LostTendersList: Showing main content with",x.length,"lost tenders"),t.jsxs("div",{"data-list":"tenders-lost",children:[x.length===0?t.jsxs("div",{className:"text-center py-5",children:[t.jsx("div",{className:"text-muted mb-3",children:t.jsx("i",{className:"bi bi-x-circle fs-1"})}),t.jsx("h5",{className:"text-muted",children:"لا يوجد مناقصات خاسرة"}),t.jsx("p",{className:"text-muted",children:g?"لا توجد نتائج للبحث في المناقصات الخاسرة":"لا توجد مناقصات خاسرة حالياً"})]}):t.jsx("div",{className:"table-responsive",children:t.jsxs("table",{className:"table table-hover custom-striped mb-0",children:[t.jsx("thead",{className:"table-light",children:t.jsxs("tr",{children:[t.jsx("th",{className:"text-center",style:{width:"60px"},children:"#"}),t.jsx("th",{className:"text-center",children:"جهة المناقصة"}),t.jsx("th",{className:"text-center",children:"السعر"}),t.jsx("th",{className:"text-center",children:"أقل سعر"}),t.jsx("th",{className:"text-center",children:"عنوان المناقصة"}),t.jsx("th",{className:"text-center",children:"فرق السعر"}),t.jsx("th",{className:"text-center",children:"الحالة"}),t.jsx("th",{className:"text-center",style:{width:"120px",paddingLeft:"40px"},children:"الإجراءات"})]})}),t.jsx("tbody",{children:K.map((e,r)=>t.jsxs("tr",{style:{height:"52px"},children:[t.jsx("td",{className:"text-center align-middle",children:t.jsx("span",{className:"fw-bold text-muted",style:{fontSize:"14px"},children:($-1)*B+r+1})}),t.jsx("td",{className:"text-center align-middle",children:t.jsx("button",{className:"btn btn-link p-0 fw-bold text-danger",onClick:()=>{e.id&&j(`/awarding-stage?tenderId=${e.id}`,{state:{tender:e,fromLostTenders:!0}})},style:{textDecoration:"none",border:"none",background:"none",cursor:"pointer",fontSize:"inherit",color:"#ff6b6b !important"},title:"انقر للانتقال إلى صفحة الترسية",children:e.entity})}),t.jsx("td",{className:"text-center align-middle",children:t.jsx(Y,{tenderId:e.id})}),t.jsx("td",{className:"text-center align-middle",children:t.jsx(Z,{tenderId:e.id})}),t.jsx("td",{className:"text-center align-middle",children:t.jsx("button",{className:"btn btn-link p-0 fw-bold text-muted tender-title-btn",onClick:()=>{e.id?j(`/awarding-stage?tenderId=${e.id}`,{state:{tender:e,fromLostTenders:!0}}):N("معرف المناقصة مفقود، لا يمكن التنقل","خطأ في التنقل")},style:{textDecoration:"none",cursor:"pointer",color:"#6c757d !important",fontWeight:"bold",border:"none",background:"none",padding:"0"},title:`انقر للانتقال إلى صفحة الترسية | Firebase ID: ${e.id||"Missing"}`,children:e.title})}),t.jsx("td",{className:"text-center align-middle",children:t.jsx(_,{tenderId:e.id})}),t.jsx("td",{className:"text-center align-middle",children:re()}),t.jsx("td",{className:"text-center",style:{paddingLeft:"40px"},children:t.jsxs("div",{className:"btn-group btn-group-sm",children:[t.jsx(z,{can:"tenders:update",mode:"disable",children:t.jsx("button",{className:"btn btn-success",onClick:()=>I(e),disabled:D,title:"استعادة إلى صفحة متابعة المناقصات",style:{transition:"transform 0.2s ease"},onMouseEnter:s=>s.currentTarget.style.transform="scale(1.1)",onMouseLeave:s=>s.currentTarget.style.transform="scale(1)",children:t.jsx("i",{className:"bi bi-arrow-up-circle"})})}),t.jsx(z,{can:"tenders:delete",mode:"disable",children:t.jsx("button",{className:"btn btn-outline-danger",onClick:()=>te(e),disabled:D,title:"حذف نهائي",children:t.jsx("i",{className:"bi bi-trash"})})})]})})]},e.internalId||e.id||`tender-${r}`))})]})}),x.length>0&&t.jsx(ce,{currentPage:$,totalPages:J,onPageChange:Q,totalItems:X,itemsPerPage:B}),t.jsx(de,{show:m.show,onClose:H,title:m.title,message:m.message,type:m.type,onConfirm:m.onConfirm,showConfirm:m.showConfirm})]}))};export{be as default};
