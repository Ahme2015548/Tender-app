import{u as J,a as K,r as o,b as Q,c as X,d as Y,j as t,e as Z,I as y,P as ee,C as te,T as x,s as se,S as ae}from"./index-1759246972099-Cj1vZ7mq.js";const ie=({refreshTrigger:$,searchTerm:C})=>{const A=J(),{hasPerm:ne}=K();console.log("TenderArchiveList is rendering");const[m,f]=o.useState([]),[T,S]=o.useState(!0),[h,D]=o.useState(null),[P,re]=o.useState(""),i=C!==void 0?C:P,[g,E]=o.useState([]),[b,l]=o.useState(!1),{logActivity:p,getCurrentUser:j}=Q(),{alertConfig:c,closeAlert:O,showSuccess:v,showError:u,showConfirm:w}=X(),{formatDate:F}=Z(),{currentPage:L,totalPages:R,paginatedItems:W,handlePageChange:M,resetPage:I,totalItems:U,itemsPerPage:k}=Y(g,30);console.log("TenderArchiveList state:",{tendersCount:m.length,loading:T,error:h});const d=async()=>{try{S(!0),D(null),console.log("Loading archived tenders...");const e=await x.getArchivedTenders();console.log("Archived tenders loaded:",e.length),e.length>0&&(console.log("=== FIRST ARCHIVED TENDER COMPLETE DATA ==="),console.log("Full tender object:",e[0]),console.log("All fields:",Object.keys(e[0])),console.log("Date fields specifically:"),Object.keys(e[0]).forEach(s=>{const n=e[0][s];n&&(s.toLowerCase().includes("date")||s.toLowerCase().includes("deadline")||s.toLowerCase().includes("انتهاء")||s.toLowerCase().includes("موعد"))&&(console.log(`  ${s}:`,n,typeof n),n&&typeof n=="object"&&n.seconds&&console.log("    Firestore timestamp - converts to:",new Date(n.seconds*1e3)))})),console.log("🔍 DEBUGGING: Before sorting, first 3 archived tenders:",e.slice(0,3).map(s=>({title:s.title,id:s.id,createdAt:s.createdAt,createdAtType:typeof s.createdAt,createdAtValue:s.createdAt instanceof Date?s.createdAt.toISOString():s.createdAt})));const a=se(e);console.log("🔍 DEBUGGING: After sorting, first 3 archived tenders:",a.slice(0,3).map(s=>({title:s.title,id:s.id,createdAt:s.createdAt,createdAtType:typeof s.createdAt,createdAtValue:s.createdAt instanceof Date?s.createdAt.toISOString():s.createdAt}))),console.log("✅ Applied global sorting - newest archived tenders first:",a.length),f(a)}catch(e){console.error("Error loading archived tenders:",e),D(e.message||"فشل في تحميل المناقصات المؤرشفة")}finally{S(!1)}};o.useEffect(()=>{d()},[$]),o.useEffect(()=>{const e=setInterval(()=>{f(a=>[...a])},6e4);return()=>clearInterval(e)},[]),o.useEffect(()=>{if(i.trim()){const e=m.filter(a=>{var s,n,r,N;return((s=a.title)==null?void 0:s.toLowerCase().includes(i.toLowerCase()))||((n=a.referenceNumber)==null?void 0:n.toLowerCase().includes(i.toLowerCase()))||((r=a.entity)==null?void 0:r.toLowerCase().includes(i.toLowerCase()))||((N=a.description)==null?void 0:N.toLowerCase().includes(i.toLowerCase()))});E(e)}else E(m);I()},[i,m,I]);const V=e=>{w(`هل أنت متأكد من استعادة هذه المناقصة من الأرشيف؟

${e.title}`,()=>G(e),"تأكيد استعادة المناقصة")},G=async e=>{try{l(!0),console.log("🔄 Starting tender restore:",e);const a={status:"active",trackingStatus:"active",trackingStage:"إعداد",trackingStartedAt:new Date().toISOString(),trackingEndedAt:null,archivedAt:null,autoArchived:!1,archiveStatus:null,absolutePersistence:!0,restoredAt:new Date().toISOString(),restoredFrom:"archive",lastStatusChange:"restored_from_archive_to_tracking",statusChangeTimestamp:new Date().toISOString(),updatedAt:new Date().toISOString()};console.log("📝 Restore data:",a);const s=await x.updateTender(e.id,a);console.log("✅ TenderService.updateTender result:",s);const n=j();p("task",`${n.name} استعاد مناقصة من الأرشيف إلى التتبع`,`تم استعادة مناقصة للتتبع: ${e.title}`),console.log("✅ Activity logged successfully"),console.log("🔄 Reloading tenders list..."),await d(),console.log("✅ Tenders list reloaded"),v(`تم استعادة المناقصة إلى صفحة التتبع: ${e.title}`,"تمت الاستعادة بنجاح")}catch(a){console.error("❌ Error restoring tender:",a),console.error("❌ Error details:",{message:a.message,stack:a.stack,tender:e}),u(`فشل في استعادة المناقصة: ${a.message}`,"خطأ في الاستعادة")}finally{l(!1),console.log("🏁 Restore process completed (finally block)")}},_=e=>{w(`هل أنت متأكد من نقل هذه المناقصة إلى المشاريع الفائزة؟

${e.title}`,()=>z(e),"تأكيد النقل للمشاريع الفائزة")},z=async e=>{try{l(!0),console.log("🏆 [ARCHIVE-TO-WON] Force moving to won projects:",e.id),await x.moveToWonProjectsAbsolute(e.id);const a=j();p("task",`${a.name} نقل مناقصة من الأرشيف للمشاريع الفائزة`,`تم نقل مناقصة: ${e.title}`),window.dispatchEvent(new CustomEvent("tenderMovedToWon",{detail:{tenderId:e.id}})),console.log("📡 Real-time event dispatched: tenderMovedToWon"),console.log("⏳ Waiting for Firestore sync..."),await new Promise(s=>setTimeout(s,1500)),f(s=>s.filter(n=>n.id!==e.id)),await d(),v(`تم نقل المناقصة إلى المشاريع الفائزة: ${e.title}`,"المناقصة متاحة الآن في قائمة المشاريع"),console.log("🏆 [ARCHIVE-TO-WON] Force move to won completed successfully")}catch(a){console.error("❌ [ARCHIVE-TO-WON] Error in force move to won:",a),u(`فشل في نقل المناقصة للمشاريع الفائزة: ${a.message}`,"خطأ في النقل")}finally{l(!1)}},B=e=>{w(`هل أنت متأكد من الحذف النهائي لهذه المناقصة؟ لن يمكن استعادتها مرة أخرى.

${e.title}`,()=>H(e),"تحذير: حذف نهائي")},H=async e=>{try{l(!0),await ae.moveToTrash(e,"tenders"),await x.deleteTender(e.id);const a=j();p("task",`${a.name} حذف مناقصة نهائياً`,`تم الحذف النهائي لمناقصة: ${e.title}`),d(),v(`تم حذف المناقصة نهائياً: ${e.title}`,"تم الحذف النهائي")}catch(a){console.error("Error permanently deleting tender:",a),u(`فشل في حذف المناقصة نهائياً: ${a.message}`,"خطأ في الحذف النهائي")}finally{l(!1)}},q=e=>e.autoArchived?t.jsx("span",{className:"badge bg-secondary text-white",children:"مؤرشف تلقائياً"}):t.jsx("span",{className:"badge bg-secondary text-white",children:"مؤرشف"});return T?(console.log("TenderArchiveList: Showing loading state"),t.jsx("div",{className:"card shadow-sm",children:t.jsxs("div",{className:"card-body text-center py-5",children:[t.jsx("div",{className:"spinner-border text-primary",role:"status",children:t.jsx("span",{className:"visually-hidden",children:"جار التحميل..."})}),t.jsx("p",{className:"mt-3 text-muted",children:"جار تحميل أرشيف المناقصات..."})]})})):h?(console.log("TenderArchiveList: Showing error state:",h),t.jsx("div",{className:"card shadow-sm",children:t.jsxs("div",{className:"card-body text-center py-5",children:[t.jsx("div",{className:"text-danger mb-3",children:t.jsx("i",{className:"bi bi-exclamation-triangle fs-1"})}),t.jsx("h5",{className:"text-danger",children:"حدث خطأ"}),t.jsx("p",{className:"text-muted",children:h}),t.jsx("div",{className:"d-flex gap-2 justify-content-center",children:t.jsxs("button",{className:"btn btn-primary",onClick:d,children:[t.jsx("i",{className:"bi bi-arrow-clockwise me-2"}),"إعادة تحميل البيانات"]})})]})})):(console.log("TenderArchiveList: Showing main content with",g.length,"archived tenders"),t.jsxs("div",{"data-list":"tenders-archive",children:[g.length===0?t.jsxs("div",{className:"text-center py-5",children:[t.jsx("div",{className:"text-muted mb-3",children:t.jsx("i",{className:"bi bi-archive fs-1"})}),t.jsx("h5",{className:"text-muted",children:"لا يوجد مناقصات مؤرشفة"}),t.jsx("p",{className:"text-muted",children:i?"لا توجد نتائج للبحث في الأرشيف":"لا توجد مناقصات مؤرشفة حالياً"})]}):t.jsx(t.Fragment,{children:t.jsx("div",{className:"table-responsive",children:t.jsxs("table",{className:"table table-hover custom-striped mb-0",children:[t.jsx("thead",{className:"table-light",children:t.jsxs("tr",{children:[t.jsx("th",{className:"text-center",style:{width:"60px"},children:"#"}),t.jsx("th",{className:"text-center",children:"جهة المناقصة"}),t.jsx("th",{className:"text-center",children:"التكلفة التقديرية"}),t.jsx("th",{className:"text-center",children:"سعر كراسة الشروط"}),t.jsx("th",{className:"text-center",children:"عنوان المناقصة"}),t.jsx("th",{className:"text-center",children:"موعد انتهاء التقديم"}),t.jsx("th",{className:"text-center",children:"الحالة"}),t.jsx("th",{className:"text-center",style:{width:"120px",paddingLeft:"40px"},children:"الإجراءات"})]})}),t.jsx("tbody",{children:W.map((e,a)=>t.jsxs("tr",{style:{height:"52px"},children:[t.jsx("td",{className:"text-center align-middle",children:t.jsx("span",{className:"fw-bold text-muted",style:{fontSize:"14px"},children:(L-1)*k+a+1})}),t.jsx("td",{className:"text-center align-middle",children:t.jsx("button",{className:"btn btn-link p-0 fw-bold text-danger",onClick:()=>{e.id&&A(`/tenders/edit/${e.id}`)},style:{textDecoration:"none",border:"none",background:"none",cursor:"pointer",fontSize:"inherit",color:"#ff6b6b !important"},title:"انقر للانتقال إلى المناقصة",children:e.entity})}),t.jsx("td",{className:"text-center align-middle",children:t.jsxs("span",{className:"badge bg-success text-white",children:[(e.estimatedValue||0).toLocaleString("en-US",{minimumFractionDigits:1,maximumFractionDigits:1})," ر.س"]})}),t.jsx("td",{className:"text-center align-middle",children:e.documentPrice&&e.documentPrice>0?t.jsxs("span",{className:"badge bg-info text-white",style:{fontSize:"11px",padding:"4px 8px"},children:[e.documentPrice," ر.س"]}):t.jsx("span",{className:"badge bg-secondary",style:{fontSize:"11px",padding:"4px 8px"},children:"غير محدد"})}),t.jsx("td",{className:"text-center align-middle",children:t.jsx("button",{className:"btn btn-link p-0 fw-bold text-muted tender-title-btn",onClick:()=>{e.id?A(`/tenders/edit/${e.id}`):u("معرف المناقصة مفقود، لا يمكن التنقل","خطأ في التنقل")},style:{textDecoration:"none",cursor:"pointer",color:"#6c757d !important",fontWeight:"bold",border:"none",background:"none",padding:"0"},title:`انقر لعرض المناقصة | Firebase ID: ${e.id||"Missing"}`,children:e.title})}),t.jsx("td",{className:"text-center align-middle",children:(()=>{const s=["submissionDeadline","deadline","submissionDate","endDate","dueDate","closingDate","applicationDeadline","tenderDeadline","date","تاريخ_الانتهاء","موعد_الانتهاء"];let n=null;for(const r of s)e[r]&&(n||(n=e[r]));if(Object.keys(e).forEach(r=>{(r.toLowerCase().includes("date")||r.toLowerCase().includes("deadline"))&&!n&&e[r]&&(n=e[r])}),n){let r=n;return n&&typeof n=="object"&&n.seconds?r=new Date(n.seconds*1e3):n&&typeof n=="object"&&n.toDate&&(r=n.toDate()),F(r)||"تاريخ غير صحيح"}else return"غير محدد"})()}),t.jsx("td",{className:"text-center align-middle",children:q(e)}),t.jsx("td",{className:"text-center",style:{paddingLeft:"40px"},children:t.jsxs("div",{className:"btn-group btn-group-sm",children:[t.jsx(y,{can:"tenders:update",mode:"disable",children:t.jsx("button",{className:"btn btn-success",onClick:()=>V(e),disabled:b,title:"استعادة من الأرشيف",style:{transition:"transform 0.2s ease"},onMouseEnter:s=>s.currentTarget.style.transform="scale(1.1)",onMouseLeave:s=>s.currentTarget.style.transform="scale(1)",children:t.jsx("i",{className:"bi bi-arrow-counterclockwise"})})}),t.jsx(y,{can:"tenders:update",mode:"disable",children:t.jsx("button",{className:"btn btn-outline-primary",onClick:()=>_(e),disabled:b,title:"نقل للمشاريع الفائزة",children:t.jsx("i",{className:"bi bi-trophy"})})}),t.jsx(y,{can:"tenders:delete",mode:"disable",children:t.jsx("button",{className:"btn btn-outline-danger",onClick:()=>B(e),disabled:b,title:"حذف نهائي",children:t.jsx("i",{className:"bi bi-trash"})})})]})})]},e.internalId||e.id||`tender-${a}`))})]})})}),g.length>0&&t.jsx(ee,{currentPage:L,totalPages:R,onPageChange:M,totalItems:U,itemsPerPage:k}),t.jsx(te,{show:c.show,onClose:O,title:c.title,message:c.message,type:c.type,onConfirm:c.onConfirm,showConfirm:c.showConfirm})]}))};export{ie as default};
