import{u as H,a as J,r as o,b as K,c as Q,d as X,j as e,e as Y,I as P,P as Z,C as ee,T as N,s as te,S as se}from"./index-1759246972099-Cj1vZ7mq.js";const ae=({refreshTrigger:b,searchTerm:m})=>{const d=H(),{hasPerm:ne}=J();console.log("TendersListFixed is rendering");const[x,y]=o.useState([]),[w,D]=o.useState(!0),[g,C]=o.useState(null),[$,ie]=o.useState(""),r=m!==void 0?m:$,[p,T]=o.useState([]),[le,v]=o.useState(!1),{logActivity:I,getCurrentUser:k}=K(),{alertConfig:c,closeAlert:z,showSuccess:S,showError:h,showConfirm:O}=Q(),{formatDate:G}=Y(),{currentPage:L,totalPages:V,paginatedItems:U,handlePageChange:B,resetPage:A,totalItems:R,itemsPerPage:E}=X(p,30);console.log("TendersListFixed state:",{tendersCount:x.length,loading:w,error:g});const u=async()=>{try{D(!0),C(null),console.log("Loading tenders...");const t=await N.getActiveTenders();console.log("Tenders loaded:",t.length),t.length>0&&(console.log("=== FIRST TENDER COMPLETE DATA ==="),console.log("Full tender object:",t[0]),console.log("All fields:",Object.keys(t[0])),console.log("Date fields specifically:"),Object.keys(t[0]).forEach(s=>{const a=t[0][s];a&&(s.toLowerCase().includes("date")||s.toLowerCase().includes("deadline")||s.toLowerCase().includes("انتهاء")||s.toLowerCase().includes("موعد"))&&(console.log(`  ${s}:`,a,typeof a),a&&typeof a=="object"&&a.seconds&&console.log("    Firestore timestamp - converts to:",new Date(a.seconds*1e3)))})),console.log("🔍 DEBUGGING: Before sorting, first 3 tenders:",t.slice(0,3).map(s=>({title:s.title,id:s.id,createdAt:s.createdAt,createdAtType:typeof s.createdAt,createdAtValue:s.createdAt instanceof Date?s.createdAt.toISOString():s.createdAt})));const n=te(t);console.log("🔍 DEBUGGING: After sorting, first 3 tenders:",n.slice(0,3).map(s=>({title:s.title,id:s.id,createdAt:s.createdAt,createdAtType:typeof s.createdAt,createdAtValue:s.createdAt instanceof Date?s.createdAt.toISOString():s.createdAt}))),console.log("✅ Applied global sorting - newest tenders first:",n.length),y(n)}catch(t){console.error("Error loading tenders:",t),C(t.message||"فشل في تحميل المناقصات")}finally{D(!1)}};o.useEffect(()=>{u()},[b]),o.useEffect(()=>{const t=setInterval(()=>{y(n=>[...n])},6e4);return()=>clearInterval(t)},[]),o.useEffect(()=>{if(r.trim()){const t=x.filter(n=>{var s,a,i,l;return((s=n.title)==null?void 0:s.toLowerCase().includes(r.toLowerCase()))||((a=n.referenceNumber)==null?void 0:a.toLowerCase().includes(r.toLowerCase()))||((i=n.entity)==null?void 0:i.toLowerCase().includes(r.toLowerCase()))||((l=n.description)==null?void 0:l.toLowerCase().includes(r.toLowerCase()))});T(t)}else T(x);A()},[r,x,A]);const M=t=>{O(`هل أنت متأكد من حذف هذه المناقصة؟

${t.title}`,()=>_(t),"تأكيد حذف المناقصة")},_=async t=>{try{v(!0),await se.moveToTrash(t,"tenders"),await N.deleteTender(t.id);const n=k();I("task",`${n.name} حذف مناقصة`,`تم حذف مناقصة: ${t.entity}`),u(),S(`تم نقل المناقصة للمهملات: ${t.title}`,"تم النقل للمهملات")}catch(n){console.error("Error deleting tender:",n),h(`فشل في نقل المناقصة للمهملات: ${n.message}`,"خطأ في النقل")}finally{v(!1)}},W=t=>{const n=new Date,s=t.submissionDeadline||t.deadline||t.submissionDate||t.endDate;if(t.status==="opened"||t.envelopesOpened===!0)return e.jsxs("div",{className:"d-flex flex-column gap-1 align-items-center",children:[e.jsx("span",{className:"badge bg-info text-white",style:{fontSize:"11px",padding:"4px 8px"},children:"تم فتح المظاريف"}),e.jsxs("button",{className:"btn btn-sm btn-outline-primary",style:{fontSize:"10px",padding:"2px 8px",cursor:"pointer",border:"1px solid #007bff"},onClick:j=>{j.stopPropagation(),d(`/tender-result?tenderId=${t.id}`)},children:[e.jsx("i",{className:"bi bi-trophy me-1"}),"عرض النتائج"]})]});if(!s)return e.jsx("span",{className:"badge bg-secondary",children:"غير محدد"});let a=s;if(s&&typeof s=="object"&&s.seconds?a=new Date(s.seconds*1e3):s&&typeof s=="object"&&s.toDate?a=s.toDate():a=new Date(s),isNaN(a.getTime()))return e.jsx("span",{className:"badge bg-secondary",children:"تاريخ غير صحيح"});const i=a.getTime()-n.getTime(),l=Math.ceil(i/(1e3*3600*24));if(l<0)return e.jsxs("div",{className:"d-flex flex-column gap-1 align-items-center",children:[e.jsx("span",{className:"badge bg-danger text-white",style:{fontSize:"11px",padding:"4px 8px"},children:"مغلقة للتقديم"}),e.jsxs("button",{className:"btn btn-sm btn-outline-info",style:{fontSize:"10px",padding:"2px 8px",cursor:"pointer",border:"1px solid #17a2b8"},onClick:async j=>{j.stopPropagation();try{await N.updateTender(t.id,{status:"opened",envelopesOpened:!0}),await u(),S('تم تحديث حالة المناقصة إلى "تم فتح المظاريف"')}catch(q){console.error("Error updating tender status:",q),h("فشل في تحديث حالة المناقصة")}},children:[e.jsx("i",{className:"bi bi-envelope-open me-1"}),"فتح المظاريف"]})]});let f="",F="text-white";return l>=6?f="bg-success":l>=3?(f="bg-warning",F="text-dark"):f="bg-danger",e.jsx("span",{className:`badge ${f} ${F}`,style:{fontSize:"12px",padding:"4px 8px"},children:l===1?"متبقي يوم واحد":l===2?"متبقي يومان":`متبقي ${l} يوم`})};return w?(console.log("TendersListFixed: Showing loading state"),e.jsx("div",{className:"card shadow-sm",children:e.jsxs("div",{className:"card-body text-center py-5",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"جار التحميل..."})}),e.jsx("p",{className:"mt-3 text-muted",children:"جار تحميل بيانات المناقصات..."})]})})):g?(console.log("TendersListFixed: Showing error state:",g),e.jsx("div",{className:"card shadow-sm",children:e.jsxs("div",{className:"card-body text-center py-5",children:[e.jsx("div",{className:"text-danger mb-3",children:e.jsx("i",{className:"bi bi-exclamation-triangle fs-1"})}),e.jsx("h5",{className:"text-danger",children:"حدث خطأ"}),e.jsx("p",{className:"text-muted",children:g}),e.jsx("div",{className:"d-flex gap-2 justify-content-center",children:e.jsxs("button",{className:"btn btn-primary",onClick:u,children:[e.jsx("i",{className:"bi bi-arrow-clockwise me-2"}),"إعادة تحميل البيانات"]})})]})})):(console.log("TendersListFixed: Showing main content with",p.length,"tenders"),e.jsxs("div",{"data-list":"tenders",children:[p.length===0?e.jsxs("div",{className:"text-center py-5",children:[e.jsx("div",{className:"text-muted mb-3",children:e.jsx("i",{className:"bi bi-clipboard-check fs-1"})}),e.jsx("h5",{className:"text-muted",children:"لا يوجد مناقصات"}),e.jsx("p",{className:"text-muted",children:r?"لا توجد نتائج للبحث المحدد":"لم يتم إضافة أي مناقصات بعد"}),!r&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>d("/tenders/add"),children:[e.jsx("i",{className:"bi bi-plus-lg me-1"}),"إضافة أول مناقصة"]})]}):e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-hover custom-striped mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-center",style:{width:"60px"},children:"#"}),e.jsx("th",{className:"text-center",children:"جهة المناقصة"}),e.jsx("th",{className:"text-center",children:"التكلفة التقديرية"}),e.jsx("th",{className:"text-center",children:"سعر كراسة الشروط"}),e.jsx("th",{className:"text-center",children:"عنوان المناقصة"}),e.jsx("th",{className:"text-center",children:"موعد انتهاء التقديم"}),e.jsx("th",{className:"text-center",children:"الحالة"}),e.jsx("th",{className:"text-center",style:{width:"120px",paddingLeft:"40px"},children:"الإجراءات"})]})}),e.jsx("tbody",{children:U.map((t,n)=>e.jsxs("tr",{style:{height:"52px"},children:[e.jsx("td",{className:"text-center align-middle",children:e.jsx("span",{className:"fw-bold text-muted",style:{fontSize:"14px"},children:(L-1)*E+n+1})}),e.jsx("td",{className:"text-center align-middle",children:e.jsx("button",{className:"btn btn-link p-0 fw-bold text-primary",onClick:()=>{t.id&&d(`/tenders/edit/${t.id}`)},style:{textDecoration:"none",border:"none",background:"none",cursor:"pointer",fontSize:"inherit"},title:"انقر للانتقال إلى المناقصة",children:t.entity})}),e.jsx("td",{className:"text-center align-middle",children:e.jsx("span",{className:"badge bg-success text-white",children:(()=>{t.entity&&t.entity.includes("أمانة حايل")&&(console.log("🔍 أمانة حايل DEBUG:"),console.log("Raw estimatedValue:",t.estimatedValue),console.log("Type:",typeof t.estimatedValue),console.log("All tender fields:",Object.keys(t)),console.log("Full tender data:",t));let s=t.estimatedValue;return typeof s=="string"&&(s=parseFloat(s)),(isNaN(s)||s==null)&&(s=0),`${s.toLocaleString("en-US",{minimumFractionDigits:1,maximumFractionDigits:1})} ر.س`})()})}),e.jsx("td",{className:"text-center align-middle",children:t.documentPrice&&t.documentPrice>0?e.jsxs("span",{className:"badge bg-info text-white",style:{fontSize:"11px",padding:"4px 8px"},children:[t.documentPrice," ر.س"]}):e.jsx("span",{className:"badge bg-secondary",style:{fontSize:"11px",padding:"4px 8px"},children:"غير محدد"})}),e.jsx("td",{className:"text-center align-middle",children:e.jsx("button",{className:"btn btn-link p-0 fw-bold text-primary tender-title-btn",onClick:()=>{t.id?d(`/tenders/edit/${t.id}`):h("معرف المناقصة مفقود، لا يمكن التنقل","خطأ في التنقل")},style:{textDecoration:"none",cursor:"pointer",color:"#007bff !important",fontWeight:"bold",border:"none",background:"none",padding:"0"},title:`انقر لعرض المناقصة | Firebase ID: ${t.id||"Missing"}`,children:t.title})}),e.jsx("td",{className:"text-center align-middle",children:(()=>{const s=["submissionDeadline","deadline","submissionDate","endDate","dueDate","closingDate","applicationDeadline","tenderDeadline","date","تاريخ_الانتهاء","موعد_الانتهاء"];let a=null;for(const i of s)t[i]&&(a||(a=t[i]));if(Object.keys(t).forEach(i=>{(i.toLowerCase().includes("date")||i.toLowerCase().includes("deadline"))&&!a&&t[i]&&(a=t[i])}),a){let i=a;return a&&typeof a=="object"&&a.seconds?i=new Date(a.seconds*1e3):a&&typeof a=="object"&&a.toDate&&(i=a.toDate()),G(i)||"تاريخ غير صحيح"}else return"غير محدد"})()}),e.jsx("td",{className:"text-center align-middle",children:W(t)}),e.jsx("td",{className:"text-center",style:{paddingLeft:"40px"},children:e.jsxs("div",{className:"btn-group btn-group-sm",children:[e.jsx(P,{can:"tenders:update",mode:"disable",children:e.jsx("button",{className:"btn btn-outline-primary",onClick:()=>{if(!t||!t.id){h("بيانات المناقصة غير صحيحة أو مفقودة","خطأ في البيانات");return}d(`/tenders/edit/${t.id}`)},title:"تعديل",children:e.jsx("i",{className:"bi bi-pencil"})})}),e.jsx(P,{can:"tenders:delete",mode:"disable",children:e.jsx("button",{className:"btn btn-outline-danger",onClick:()=>M(t),title:"حذف",children:e.jsx("i",{className:"bi bi-trash"})})})]})})]},t.internalId||t.id||`tender-${n}`))})]})}),p.length>0&&e.jsx(Z,{currentPage:L,totalPages:V,onPageChange:B,totalItems:R,itemsPerPage:E}),e.jsx(ee,{show:c.show,onClose:z,title:c.title,message:c.message,type:c.type,onConfirm:c.onConfirm,showConfirm:c.showConfirm})]}))},re=({refreshTrigger:b,searchTerm:m})=>(console.log("TendersList wrapper is rendering - delegating to TendersListFixed"),e.jsx(ae,{refreshTrigger:b,searchTerm:m}));export{re as default};
