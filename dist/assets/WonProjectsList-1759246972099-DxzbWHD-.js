import{u as oe,a as re,r as a,b as ae,c as ne,d as ie,j as t,I as U,P as ce,C as le,T as y,s as de,t as ge,f as me,g as ue,S as fe}from"./index-1759246972099-Cj1vZ7mq.js";const je=({refreshTrigger:B,searchTerm:P})=>{const C=oe(),{hasPerm:he}=re();console.log("WonProjectsList is rendering");const[h,E]=a.useState([]),[S,T]=a.useState(!0),[x,v]=a.useState(null),[M,xe]=a.useState(""),g=P!==void 0?P:M,[p,L]=a.useState([]),[O,j]=a.useState(!1),[l,z]=a.useState({}),[d,G]=a.useState({}),{logActivity:F,getCurrentUser:W}=ae(),{alertConfig:m,closeAlert:V,showSuccess:R,showError:b,showConfirm:A}=ne(),{currentPage:D,totalPages:q,paginatedItems:H,handlePageChange:K,resetPage:k,totalItems:Q,itemsPerPage:$}=ie(p,30);console.log("WonProjectsList state:",{tendersCount:h.length,loading:S,error:x});const w=async e=>{try{if(l[e])return l[e];console.log("💰 [WON-PROJECTS] Fetching final price from tender study for:",e);const o=await ge.getTenderStudy(e);let s=0;if(o.success&&o.data&&o.data.profitCalculation)s=parseFloat(o.data.profitCalculation.finalPrice||0),console.log("✅ [WON-PROJECTS] Found final price from study:",s,"for tender:",e);else{console.log("⚠️ [WON-PROJECTS] No study data found, trying tender items as fallback...");try{const r=await me.getAllTenderItems(e);r&&r.length>0&&(s=r.reduce((i,c)=>{const n=c.totalPrice||c.quantity*c.unitPrice||0;return i+n},0),console.log("📋 [WON-PROJECTS] Fallback calculation from items:",s))}catch(r){console.error("❌ [WON-PROJECTS] Items fallback failed:",r)}}return console.log("✅ [WON-PROJECTS] Final price determined:",s,"for tender:",e),z(r=>({...r,[e]:s})),s}catch(o){return console.error("❌ [WON-PROJECTS] Error fetching final price from study:",o),0}},N=async e=>{try{if(d[e]!==void 0)return d[e];console.log("💰 [WON-PROJECTS] Fetching lowest price from tender result for:",e);const o=await ue.getTenderResultStats(e);let s=0;return o&&o.lowestPrice?(s=parseFloat(o.lowestPrice||0),console.log("✅ [WON-PROJECTS] Found lowest price from result stats:",s,"for tender:",e)):console.log("⚠️ [WON-PROJECTS] No result stats found for tender:",e),console.log("✅ [WON-PROJECTS] Lowest price determined:",s,"for tender:",e),G(r=>({...r,[e]:s})),s}catch(o){return console.error("❌ [WON-PROJECTS] Error fetching lowest price from result stats:",o),0}},f=async()=>{try{T(!0),v(null),console.log("Loading won projects...");const e=await y.getWonProjects();console.log("Won projects loaded:",e.length),e.length>0&&(console.log("=== FIRST WON PROJECT COMPLETE DATA ==="),console.log("Full tender object:",e[0]),console.log("All fields:",Object.keys(e[0])),console.log("Date fields specifically:"),Object.keys(e[0]).forEach(s=>{const r=e[0][s];r&&(s.toLowerCase().includes("date")||s.toLowerCase().includes("deadline")||s.toLowerCase().includes("انتهاء")||s.toLowerCase().includes("موعد"))&&(console.log(`  ${s}:`,r,typeof r),r&&typeof r=="object"&&r.seconds&&console.log("    Firestore timestamp - converts to:",new Date(r.seconds*1e3)))})),console.log("🔍 DEBUGGING: Before sorting, first 3 won projects:",e.slice(0,3).map(s=>({title:s.title,id:s.id,createdAt:s.createdAt,createdAtType:typeof s.createdAt,createdAtValue:s.createdAt instanceof Date?s.createdAt.toISOString():s.createdAt})));const o=de(e);console.log("🔍 DEBUGGING: After sorting, first 3 won projects:",o.slice(0,3).map(s=>({title:s.title,id:s.id,createdAt:s.createdAt,createdAtType:typeof s.createdAt,createdAtValue:s.createdAt instanceof Date?s.createdAt.toISOString():s.createdAt}))),console.log("✅ Applied global sorting - newest won projects first:",o.length),E(o),o.forEach(s=>{s.id&&(w(s.id),N(s.id))})}catch(e){console.error("Error loading won projects:",e),v(e.message||"فشل في تحميل المشاريع الفائزة")}finally{T(!1)}},X=({tenderId:e})=>{const[o,s]=a.useState(0),[r,i]=a.useState(!0);return a.useEffect(()=>{const c=async()=>{i(!0);try{const n=await w(e);s(n)}catch(n){console.error("Error loading total for tender:",e,n)}finally{i(!1)}};e&&(l[e]!==void 0?(s(l[e]),i(!1)):c())},[e,l]),r?t.jsxs("span",{className:"badge bg-secondary text-white",children:[t.jsx("i",{className:"bi bi-hourglass-split me-1"}),"يحسب..."]}):t.jsxs("span",{className:"badge bg-success text-white",children:[o.toLocaleString("en-US",{minimumFractionDigits:1,maximumFractionDigits:1})," ر.س"]})},Y=({tenderId:e})=>{const[o,s]=a.useState(0),[r,i]=a.useState(!0);return a.useEffect(()=>{const c=async()=>{i(!0);try{const n=await N(e);s(n)}catch(n){console.error("Error loading lowest price for tender:",e,n)}finally{i(!1)}};e&&(d[e]!==void 0?(s(d[e]),i(!1)):c())},[e,d]),r?t.jsxs("span",{className:"badge bg-secondary text-white",children:[t.jsx("i",{className:"bi bi-hourglass-split me-1"}),"يحسب..."]}):o>0?t.jsxs("span",{className:"badge text-white",style:{fontSize:"11px",padding:"4px 8px",backgroundColor:"#6c757d"},children:[o.toLocaleString("en-US",{minimumFractionDigits:1,maximumFractionDigits:1})," ر.س"]}):t.jsx("span",{className:"badge bg-secondary text-white",style:{fontSize:"11px",padding:"4px 8px"},children:"غير محدد"})},Z=({tenderId:e})=>{const[o,s]=a.useState(null),[r,i]=a.useState(!0);if(a.useEffect(()=>{const c=async()=>{i(!0);try{const[n,u]=await Promise.all([w(e),N(e)]);if(console.log("📊 [PRICE-DIFFERENCE] Our price:",n,"Lowest price:",u,"for tender:",e),n>0&&u>0){const J=n-u;s(J),console.log("💰 [PRICE-DIFFERENCE] Calculated difference:",J,"for tender:",e)}else s(null),console.log("⚠️ [PRICE-DIFFERENCE] Missing price data for tender:",e)}catch(n){console.error("❌ [PRICE-DIFFERENCE] Error calculating price difference:",n),s(null)}finally{i(!1)}};if(e)if(l[e]!==void 0&&d[e]!==void 0){const n=l[e],u=d[e];n>0&&u>0?s(n-u):s(null),i(!1)}else c()},[e,l,d]),r)return t.jsxs("span",{className:"badge bg-secondary text-white",children:[t.jsx("i",{className:"bi bi-hourglass-split me-1"}),"يحسب..."]});if(o!==null){const c=o>0;return t.jsxs("span",{className:"badge bg-primary text-white",style:{fontSize:"11px",padding:"4px 8px"},children:[c&&"+",o.toLocaleString("en-US",{minimumFractionDigits:1,maximumFractionDigits:1})," ر.س"]})}else return t.jsx("span",{className:"badge bg-secondary text-white",style:{fontSize:"11px",padding:"4px 8px"},children:"غير متوفر"})};a.useEffect(()=>{f()},[B]),a.useEffect(()=>{const e=()=>{console.log("🔔 Event received: tender moved to won projects, reloading..."),f()};return window.addEventListener("tenderMovedToWon",e),()=>{window.removeEventListener("tenderMovedToWon",e)}},[]),a.useEffect(()=>{const e=setInterval(()=>{E(o=>[...o])},6e4);return()=>clearInterval(e)},[]),a.useEffect(()=>{if(g.trim()){const e=h.filter(o=>{var s,r,i,c;return((s=o.title)==null?void 0:s.toLowerCase().includes(g.toLowerCase()))||((r=o.referenceNumber)==null?void 0:r.toLowerCase().includes(g.toLowerCase()))||((i=o.entity)==null?void 0:i.toLowerCase().includes(g.toLowerCase()))||((c=o.description)==null?void 0:c.toLowerCase().includes(g.toLowerCase()))});L(e)}else L(h);k()},[g,h,k]);const _=e=>{A(`هل أنت متأكد من نقل هذا المشروع إلى صفحة متابعة المناقصات؟

${e.title}

سيتم إضافته مباشرة لصفحة التتبع`,()=>I(e),"تأكيد نقل للتتبع")},I=async e=>{try{j(!0);const o="active",s=!0;console.log("🎯 [BULLETPROOF-WON] Force restoring to tracking page for:",e.id),await y.moveFromWonProjectsAbsolute(e.id,o,s);const r=W();F("task",`${r.name} نقل مشروع من الفائزة إلى التتبع`,`تم نقل مشروع: ${e.title}`),f(),R(`تم نقل المشروع إلى التتبع: ${e.title}`,"المشروع متاح الآن في صفحة متابعة المناقصات"),console.log("🎯 [BULLETPROOF-WON] Force restoration to tracking completed successfully")}catch(o){console.error("❌ [BULLETPROOF-WON] Error in force restoration to tracking:",o),b(`فشل في النقل إلى التتبع: ${o.message}`,"خطأ في النقل")}finally{j(!1)}},ee=e=>{A(`هل أنت متأكد من الحذف النهائي لهذا المشروع؟ لن يمكن استعادته مرة أخرى.

${e.title}`,()=>te(e),"تحذير: حذف نهائي")},te=async e=>{try{j(!0),await fe.moveToTrash(e,"tenders"),await y.deleteTender(e.id);const o=W();F("task",`${o.name} حذف مشروع فائز نهائياً`,`تم الحذف النهائي لمشروع: ${e.title}`),f(),R(`تم حذف المشروع نهائياً: ${e.title}`,"تم الحذف النهائي")}catch(o){console.error("Error permanently deleting project:",o),b(`فشل في حذف المشروع نهائياً: ${o.message}`,"خطأ في الحذف النهائي")}finally{j(!1)}},se=e=>t.jsx("span",{className:"badge bg-success text-white",children:"فائزة"});return S?(console.log("WonProjectsList: Showing loading state"),t.jsx("div",{className:"card shadow-sm",children:t.jsxs("div",{className:"card-body text-center py-5",children:[t.jsx("div",{className:"spinner-border text-primary",role:"status",children:t.jsx("span",{className:"visually-hidden",children:"جار التحميل..."})}),t.jsx("p",{className:"mt-3 text-muted",children:"جار تحميل المشاريع الفائزة..."})]})})):x?(console.log("WonProjectsList: Showing error state:",x),t.jsx("div",{className:"card shadow-sm",children:t.jsxs("div",{className:"card-body text-center py-5",children:[t.jsx("div",{className:"text-danger mb-3",children:t.jsx("i",{className:"bi bi-exclamation-triangle fs-1"})}),t.jsx("h5",{className:"text-danger",children:"حدث خطأ"}),t.jsx("p",{className:"text-muted",children:x}),t.jsx("div",{className:"d-flex gap-2 justify-content-center",children:t.jsxs("button",{className:"btn btn-primary",onClick:f,children:[t.jsx("i",{className:"bi bi-arrow-clockwise me-2"}),"إعادة تحميل البيانات"]})})]})})):(console.log("WonProjectsList: Showing main content with",p.length,"won projects"),t.jsxs("div",{"data-list":"projects-won",children:[p.length===0?t.jsxs("div",{className:"text-center py-5",children:[t.jsx("div",{className:"text-muted mb-3",children:t.jsx("i",{className:"bi bi-trophy fs-1"})}),t.jsx("h5",{className:"text-muted",children:"لا يوجد مشاريع فائزة"}),t.jsx("p",{className:"text-muted",children:g?"لا توجد نتائج للبحث في المشاريع الفائزة":"لا توجد مشاريع فائزة حالياً"})]}):t.jsx("div",{className:"table-responsive",children:t.jsxs("table",{className:"table table-hover custom-striped mb-0",children:[t.jsx("thead",{className:"table-light",children:t.jsxs("tr",{children:[t.jsx("th",{className:"text-center",style:{width:"60px"},children:"#"}),t.jsx("th",{className:"text-center",children:"جهة المناقصة"}),t.jsx("th",{className:"text-center",children:"السعر"}),t.jsx("th",{className:"text-center",children:"أقل سعر"}),t.jsx("th",{className:"text-center",children:"عنوان المناقصة"}),t.jsx("th",{className:"text-center",children:"فرق السعر"}),t.jsx("th",{className:"text-center",children:"الحالة"}),t.jsx("th",{className:"text-center",style:{width:"120px",paddingLeft:"40px"},children:"الإجراءات"})]})}),t.jsx("tbody",{children:H.map((e,o)=>t.jsxs("tr",{style:{height:"52px"},children:[t.jsx("td",{className:"text-center align-middle",children:t.jsx("span",{className:"fw-bold text-muted",style:{fontSize:"14px"},children:(D-1)*$+o+1})}),t.jsx("td",{className:"text-center align-middle",children:t.jsx("button",{className:"btn btn-link p-0 fw-bold text-success",onClick:()=>{e.id&&C(`/awarding-stage?tenderId=${e.id}`,{state:{tender:e,fromWonProjects:!0}})},style:{textDecoration:"none",border:"none",background:"none",cursor:"pointer",fontSize:"inherit",color:"#28a745 !important"},title:"انقر للانتقال إلى صفحة الترسية",children:e.entity})}),t.jsx("td",{className:"text-center align-middle",children:t.jsx(X,{tenderId:e.id})}),t.jsx("td",{className:"text-center align-middle",children:t.jsx(Y,{tenderId:e.id})}),t.jsx("td",{className:"text-center align-middle",children:t.jsx("button",{className:"btn btn-link p-0 fw-bold text-muted tender-title-btn",onClick:()=>{e.id?C(`/awarding-stage?tenderId=${e.id}`,{state:{tender:e,fromWonProjects:!0}}):b("معرف المناقصة مفقود، لا يمكن التنقل","خطأ في التنقل")},style:{textDecoration:"none",cursor:"pointer",color:"#6c757d !important",fontWeight:"bold",border:"none",background:"none",padding:"0"},title:`انقر للانتقال إلى صفحة الترسية | Firebase ID: ${e.id||"Missing"}`,children:e.title})}),t.jsx("td",{className:"text-center align-middle",children:t.jsx(Z,{tenderId:e.id})}),t.jsx("td",{className:"text-center align-middle",children:se()}),t.jsx("td",{className:"text-center",style:{paddingLeft:"40px"},children:t.jsxs("div",{className:"btn-group btn-group-sm",children:[t.jsx(U,{can:"tenders:update",mode:"disable",children:t.jsx("button",{className:"btn btn-outline-primary",onClick:()=>_(e),disabled:O,title:"استعادة إلى صفحة متابعة المناقصات",children:t.jsx("i",{className:"bi bi-arrow-up-circle"})})}),t.jsx(U,{can:"tenders:delete",mode:"disable",children:t.jsx("button",{className:"btn btn-outline-danger",onClick:()=>ee(e),disabled:O,title:"حذف نهائي",children:t.jsx("i",{className:"bi bi-trash"})})})]})})]},e.internalId||e.id||`tender-${o}`))})]})}),p.length>0&&t.jsx(ce,{currentPage:D,totalPages:q,onPageChange:K,totalItems:Q,itemsPerPage:$}),t.jsx(le,{show:m.show,onClose:V,title:m.title,message:m.message,type:m.type,onConfirm:m.onConfirm,showConfirm:m.showConfirm})]}))};export{je as default};
