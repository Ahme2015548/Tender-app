import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { useActivity } from './ActivityManager';
import CustomAlert from './CustomAlert';
import { useCustomAlert } from '../hooks/useCustomAlert';
import ModernSpinner from './ModernSpinner';
import TenderItemsFirebaseService from '../services/TenderItemsFirebaseService';
import { RawMaterialService } from '../services/rawMaterialService';
import { LocalProductService } from '../services/localProductService';
import { ForeignProductService } from '../services/foreignProductService';

const TenderItemsListFirebase = ({ 
  tenderId, 
  onTotalChange, 
  onItemsChange
}) => {
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(false);
  const [refreshing, setRefreshing] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [editingItem, setEditingItem] = useState(null);
  const [editQuantity, setEditQuantity] = useState('');
  const [sortBy, setSortBy] = useState('createdAt');
  const [sortOrder, setSortOrder] = useState('desc');
  
  const { logActivity, getCurrentUser } = useActivity();
  const { alertConfig, closeAlert, showSuccess, showError, showConfirm } = useCustomAlert();

  // Load items from Firebase ONLY
  const loadItems = useCallback(async () => {
    if (!tenderId) {
      setItems([]);
      return;
    }

    try {
      setLoading(true);
      console.log('üî• [FIREBASE-ONLY] Loading tender items for tender:', tenderId);
      
      const firebaseItems = await TenderItemsFirebaseService.getTenderItems(tenderId);
      
      setItems(firebaseItems);
      console.log('‚úÖ [FIREBASE-ONLY] Loaded items:', firebaseItems.length);
      
    } catch (error) {
      console.error('‚ùå [FIREBASE-ONLY] Error loading tender items:', error);
      showError(`ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸÜŸàÿØ ÿßŸÑŸÖŸÜÿßŸÇÿµÿ©: ${error.message}`, 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ');
      setItems([]);
    } finally {
      setLoading(false);
    }
  }, [tenderId, showError]);

  // Load items on mount and when tenderId changes
  useEffect(() => {
    loadItems();
  }, [loadItems]);

  // Listen for real-time updates
  useEffect(() => {
    const handleUpdate = () => {
      console.log('üîÑ [FIREBASE-ONLY] Real-time update triggered');
      loadItems();
    };

    window.addEventListener('tenderItemsUpdated', handleUpdate);
    return () => window.removeEventListener('tenderItemsUpdated', handleUpdate);
  }, [loadItems]);

  // Calculate totals
  const totals = useMemo(() => {
    const totalPrice = items.reduce((sum, item) => sum + (item.totalPrice || 0), 0);
    const totalQuantity = items.reduce((sum, item) => sum + (item.quantity || 0), 0);
    return { totalPrice, totalQuantity };
  }, [items]);

  // Notify parent of changes
  useEffect(() => {
    onTotalChange?.(totals.totalPrice);
    onItemsChange?.(items);
  }, [totals.totalPrice, items, onTotalChange, onItemsChange]);

  // Filter and sort items
  const filteredAndSortedItems = useMemo(() => {
    let filtered = items;
    
    // Apply search filter
    if (searchTerm.trim()) {
      const searchLower = searchTerm.toLowerCase();
      filtered = items.filter(item => 
        (item.materialName || '').toLowerCase().includes(searchLower) ||
        (item.materialCategory || '').toLowerCase().includes(searchLower) ||
        (item.supplierInfo?.name || '').toLowerCase().includes(searchLower) ||
        (item.materialType || '').toLowerCase().includes(searchLower)
      );
    }
    
    // Apply sorting
    const sorted = [...filtered].sort((a, b) => {
      let aValue, bValue;
      
      switch (sortBy) {
        case 'name':
          aValue = (a.materialName || '').toLowerCase();
          bValue = (b.materialName || '').toLowerCase();
          break;
        case 'price':
          aValue = a.totalPrice || 0;
          bValue = b.totalPrice || 0;
          break;
        case 'quantity':
          aValue = a.quantity || 0;
          bValue = b.quantity || 0;
          break;
        case 'category':
          aValue = (a.materialCategory || '').toLowerCase();
          bValue = (b.materialCategory || '').toLowerCase();
          break;
        case 'createdAt':
        default:
          aValue = a.createdAt || new Date(0);
          bValue = b.createdAt || new Date(0);
          break;
      }
      
      if (sortOrder === 'asc') {
        return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
      } else {
        return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
      }
    });
    
    return sorted;
  }, [items, searchTerm, sortBy, sortOrder]);

  // Delete item (Firebase only)
  const deleteItem = async (item) => {
    try {
      setLoading(true);
      
      await TenderItemsFirebaseService.deleteTenderItem(item.id);
      
      // Remove from local state
      setItems(prev => prev.filter(i => i.internalId !== item.internalId));
      
      // Log activity
      const currentUser = getCurrentUser();
      logActivity('task', `${currentUser.name} ÿ≠ÿ∞ŸÅ ÿ®ŸÜÿØ ŸÖŸÜ ÿßŸÑŸÖŸÜÿßŸÇÿµÿ©`, `ÿßŸÑÿ®ŸÜÿØ: ${item.materialName}`);
      
      showSuccess('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸÜÿØ ÿ®ŸÜÿ¨ÿßÿ≠', 'ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ');
      
    } catch (error) {
      console.error('‚ùå [FIREBASE-ONLY] Error deleting item:', error);
      showError(`ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸÜÿØ: ${error.message}`, 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ÿ∞ŸÅ');
    } finally {
      setLoading(false);
    }
  };

  // Update item quantity (Firebase only)
  const updateQuantity = async (item, newQuantity) => {
    try {
      const quantity = parseFloat(newQuantity);
      if (isNaN(quantity) || quantity <= 0) {
        showError('ÿßŸÑŸÉŸÖŸäÿ© Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ±ŸÇŸÖ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ ÿµŸÅÿ±', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÉŸÖŸäÿ©');
        return;
      }

      const updatedItem = await TenderItemsFirebaseService.updateTenderItemQuantity(item.id, quantity);

      // Update local state
      setItems(prev => prev.map(i => 
        i.internalId === item.internalId ? updatedItem : i
      ));

      setEditingItem(null);
      setEditQuantity('');
      
      // Log activity
      const currentUser = getCurrentUser();
      logActivity('task', `${currentUser.name} ÿπÿØŸÑ ŸÉŸÖŸäÿ© ÿßŸÑÿ®ŸÜÿØ`, `${item.materialName}: ${quantity}`);
      
      showSuccess('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÉŸÖŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠', 'ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´');
      
    } catch (error) {
      console.error('‚ùå [FIREBASE-ONLY] Error updating quantity:', error);
      showError(`ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÉŸÖŸäÿ©: ${error.message}`, 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´');
    }
  };

  // Refresh prices from source materials (Firebase only)
  const refreshPrices = async () => {
    if (items.length === 0) {
      showError('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸÜŸàÿØ ŸÑŸÑÿ™ÿ≠ÿØŸäÿ´', 'ŸÇÿßÿ¶ŸÖÿ© ŸÅÿßÿ±ÿ∫ÿ©');
      return;
    }

    try {
      setRefreshing(true);
      console.log('üî• [FIREBASE-ONLY] Refreshing prices...');
      
      const updatedItems = await TenderItemsFirebaseService.refreshTenderItemsPricing(tenderId);
      setItems(updatedItems);
      
      showSuccess('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≥ÿπÿßÿ± ŸÖŸÜ ÿßŸÑŸÖÿµÿßÿØÿ± ÿßŸÑÿ£ÿµŸÑŸäÿ©', 'ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´');
      
    } catch (error) {
      console.error('‚ùå [FIREBASE-ONLY] Error refreshing prices:', error);
      showError(`ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ£ÿ≥ÿπÿßÿ±: ${error.message}`, 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´');
    } finally {
      setRefreshing(false);
    }
  };

  // Navigate to material edit page
  const navigateToMaterial = useCallback(async (item) => {
    try {
      let materialDetails = null;
      let editPath = '';
      
      switch (item.materialType) {
        case 'rawMaterial':
          materialDetails = await RawMaterialService.getRawMaterialByInternalId(item.materialInternalId);
          editPath = `/raw-materials/edit/${materialDetails?.id}`;
          break;
        case 'localProduct':
          materialDetails = await LocalProductService.getLocalProductByInternalId(item.materialInternalId);
          editPath = `/local-products/edit/${materialDetails?.id}`;
          break;
        case 'foreignProduct':
          materialDetails = await ForeignProductService.getForeignProductByInternalId(item.materialInternalId);
          editPath = `/foreign-products/edit/${materialDetails?.id}`;
          break;
      }
      
      if (materialDetails) {
        window.open(editPath, '_blank');
      } else {
        showError('ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ Ÿáÿ∞Ÿá ÿßŸÑŸÖÿßÿØÿ©', 'ÿÆÿ∑ÿ£');
      }
    } catch (error) {
      console.error('‚ùå [FIREBASE-ONLY] Error navigating to material:', error);
      showError('ŸÅÿ¥ŸÑ ŸÅŸä ŸÅÿ™ÿ≠ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÖÿßÿØÿ©', 'ÿÆÿ∑ÿ£');
    }
  }, [showError]);

  // Handle delete confirmation
  const handleDeleteClick = (item) => {
    showConfirm(
      `ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ®ŸÜÿØÿü\n\n${item.materialName}`,
      () => deleteItem(item),
      'ÿ™ÿ£ŸÉŸäÿØ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸÜÿØ'
    );
  };

  // Handle edit quantity
  const handleEditQuantity = (item) => {
    setEditingItem(item);
    setEditQuantity((item.quantity || 1).toString());
  };

  const handleSaveQuantity = () => {
    if (editingItem) {
      updateQuantity(editingItem, editQuantity);
    }
  };

  const handleCancelEdit = () => {
    setEditingItem(null);
    setEditQuantity('');
  };

  // Handle sorting
  const handleSort = (field) => {
    if (sortBy === field) {
      setSortOrder(prev => prev === 'asc' ? 'desc' : 'asc');
    } else {
      setSortBy(field);
      setSortOrder('asc');
    }
  };

  const getSortIcon = (field) => {
    if (sortBy !== field) return 'bi-arrow-down-up';
    return sortOrder === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down';
  };

  // Add item from other pages (exposed method)
  const addItem = useCallback(async (materialInternalId, materialType, quantity = 1) => {
    try {
      if (!tenderId) {
        throw new Error('ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖŸÜÿßŸÇÿµÿ© ŸÖÿ∑ŸÑŸàÿ®');
      }

      console.log('üî• [FIREBASE-ONLY] Adding item:', { materialInternalId, materialType, quantity });
      
      const newItem = await TenderItemsFirebaseService.addMaterialToTender(
        tenderId, 
        materialInternalId, 
        materialType, 
        quantity
      );
      
      if (newItem) {
        setItems(prev => [...prev, newItem]);
        
        // Log activity
        const currentUser = getCurrentUser();
        logActivity('task', `${currentUser.name} ÿ£ÿ∂ÿßŸÅ ÿ®ŸÜÿØ ŸÑŸÑŸÖŸÜÿßŸÇÿµÿ©`, `ÿßŸÑÿ®ŸÜÿØ: ${newItem.materialName}`);
        
        showSuccess('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ®ŸÜÿØ ÿ®ŸÜÿ¨ÿßÿ≠', 'ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©');
        return newItem;
      }
      
    } catch (error) {
      console.error('‚ùå [FIREBASE-ONLY] Error adding item:', error);
      showError(`ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ®ŸÜÿØ: ${error.message}`, 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©');
      return null;
    }
  }, [tenderId, getCurrentUser, logActivity, showSuccess, showError]);

  // Expose addItem method for external use
  React.useImperativeHandle(React.forwardRef(() => null), () => ({
    addItem
  }));

  if (loading && items.length === 0) {
    return (
      <div className="card shadow-sm">
        <div className="card-body d-flex justify-content-center align-items-center" style={{ height: '200px' }}>
          <ModernSpinner size="large" />
        </div>
      </div>
    );
  }

  return (
    <div className="card shadow-sm">
      {/* Header */}
      <div className="card-header bg-white border-bottom py-3">
        <div className="row align-items-center">
          <div className="col-md-4">
            <h6 className="mb-0 fw-bold text-primary">
              <i className="bi bi-list-task me-2"></i>
              ÿ®ŸÜŸàÿØ ÿßŸÑŸÖŸÜÿßŸÇÿµÿ© ({filteredAndSortedItems.length})
            </h6>
            <small className="text-muted">
              <i className="bi bi-cloud-check text-success me-1"></i>
              ŸÖÿ™ÿµŸÑ ÿ®ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            </small>
          </div>
          <div className="col-md-8">
            <div className="d-flex justify-content-end align-items-center gap-2">
              {/* Search */}
              <div className="input-group" style={{ maxWidth: '250px' }}>
                <input
                  type="text"
                  className="form-control form-control-sm"
                  placeholder="ÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ®ŸÜŸàÿØ..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  style={{ fontSize: '13px' }}
                />
                <span className="input-group-text">
                  <i className="bi bi-search" style={{ transform: 'scaleX(-1)' }}></i>
                </span>
              </div>
              
              {/* Refresh prices button */}
              <button
                type="button"
                className="btn btn-success btn-sm"
                onClick={refreshPrices}
                disabled={refreshing || items.length === 0}
                style={{ fontSize: '13px', minWidth: '100px' }}
              >
                {refreshing ? (
                  <>
                    <ModernSpinner size="small" />
                    <span className="ms-1">ÿ™ÿ≠ÿØŸäÿ´...</span>
                  </>
                ) : (
                  <>
                    <i className="bi bi-arrow-clockwise me-1"></i>
                    ÿ™ÿ≠ÿØŸäÿ´ ÿ£ÿ≥ÿπÿßÿ±
                  </>
                )}
              </button>
              
              {/* Total summary */}
              <div className="d-flex align-items-center bg-light px-3 py-1 rounded">
                <span className="text-muted me-2" style={{ fontSize: '13px' }}>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:</span>
                <span className="fw-bold text-primary" style={{ fontSize: '14px' }}>
                  {totals.totalPrice.toLocaleString('en-US')} ÿ±.ÿ≥
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Body */}
      <div className="card-body p-0">
        {filteredAndSortedItems.length === 0 ? (
          <div className="text-center py-5">
            <div className="text-muted mb-3">
              <i className="bi bi-list-check" style={{ fontSize: '3rem' }}></i>
            </div>
            <h6 className="text-muted">
              {searchTerm ? 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÑŸÑÿ®ÿ≠ÿ´' : 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸÜŸàÿØ ŸÅŸä ÿßŸÑŸÖŸÜÿßŸÇÿµÿ©'}
            </h6>
            <p className="text-muted small">
              {!searchTerm && (
                <>
                  <i className="bi bi-cloud text-primary me-1"></i>
                  ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ≤ÿ± "ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸÜÿØ" ŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿßÿØ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                </>
              )}
            </p>
          </div>
        ) : (
          <div className="table-responsive">
            <table className="table table-hover custom-striped mb-0">
              <thead className="table-light">
                <tr>
                  <th className="text-center" style={{ width: '50px' }}>#</th>
                  <th 
                    className="text-center sortable-header" 
                    onClick={() => handleSort('name')}
                    style={{ cursor: 'pointer' }}
                  >
                    <div className="d-flex align-items-center justify-content-center">
                      ÿßÿ≥ŸÖ ÿßŸÑŸÖÿßÿØÿ©
                      <i className={`bi ${getSortIcon('name')} ms-1`}></i>
                    </div>
                  </th>
                  <th 
                    className="text-center sortable-header"
                    onClick={() => handleSort('category')}
                    style={{ cursor: 'pointer' }}
                  >
                    <div className="d-flex align-items-center justify-content-center">
                      ÿßŸÑŸÅÿ¶ÿ©
                      <i className={`bi ${getSortIcon('category')} ms-1`}></i>
                    </div>
                  </th>
                  <th className="text-center">ÿßŸÑŸÜŸàÿπ</th>
                  <th className="text-center">ÿßŸÑŸàÿ≠ÿØÿ©</th>
                  <th 
                    className="text-center sortable-header"
                    onClick={() => handleSort('quantity')}
                    style={{ cursor: 'pointer' }}
                  >
                    <div className="d-flex align-items-center justify-content-center">
                      ÿßŸÑŸÉŸÖŸäÿ©
                      <i className={`bi ${getSortIcon('quantity')} ms-1`}></i>
                    </div>
                  </th>
                  <th className="text-center">ÿ≥ÿπÿ± ÿßŸÑŸàÿ≠ÿØÿ©</th>
                  <th className="text-center">ÿßŸÑŸÖŸàÿ±ÿØ</th>
                  <th 
                    className="text-center sortable-header"
                    onClick={() => handleSort('price')}
                    style={{ cursor: 'pointer' }}
                  >
                    <div className="d-flex align-items-center justify-content-center">
                      ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≥ÿπÿ±
                      <i className={`bi ${getSortIcon('price')} ms-1`}></i>
                    </div>
                  </th>
                  <th className="text-center" style={{ width: '120px' }}>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                </tr>
              </thead>
              <tbody>
                {filteredAndSortedItems.map((item, index) => {
                  const materialName = item.materialName || 'ŸÖÿßÿØÿ© ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØÿ©';
                  const materialCategory = item.materialCategory || '-';
                  const materialUnit = item.materialUnit || 'ŸÇÿ∑ÿπÿ©';
                  const unitPrice = item.unitPrice || 0;
                  const totalPrice = item.totalPrice || 0;
                  const quantity = item.quantity || 1;
                  const supplier = item.supplierInfo?.name || '-';
                  
                  const materialTypeDisplay = {
                    'rawMaterial': { label: 'ŸÖÿßÿØÿ© ÿÆÿßŸÖ', icon: 'bi-gear', color: 'danger' },
                    'localProduct': { label: 'ŸÖŸÜÿ™ÿ¨ ŸÖÿ≠ŸÑŸä', icon: 'bi-house', color: 'success' },
                    'foreignProduct': { label: 'ŸÖŸÜÿ™ÿ¨ ŸÖÿ≥ÿ™Ÿàÿ±ÿØ', icon: 'bi-globe', color: 'info' }
                  };
                  
                  const typeInfo = materialTypeDisplay[item.materialType] || materialTypeDisplay['rawMaterial'];
                  
                  return (
                    <tr key={item.id} style={{
                      backgroundColor: index % 2 === 0 ? '#ffffff' : '#f8f9fa'
                    }}>
                      <td className="text-center">
                        <span className="fw-bold text-muted">{index + 1}</span>
                      </td>
                      <td className="text-center">
                        <button
                          className="btn btn-link p-0 text-decoration-none fw-bold text-primary"
                          onClick={() => navigateToMaterial(item)}
                          title={`ÿ™ÿ≠ÿ±Ÿäÿ±: ${materialName}`}
                          style={{ fontSize: '14px' }}
                        >
                          {materialName}
                        </button>
                      </td>
                      <td className="text-center">
                        <span className="text-muted">{materialCategory}</span>
                      </td>
                      <td className="text-center">
                        <span className={`badge bg-${typeInfo.color} bg-opacity-10 text-${typeInfo.color}`} 
                              style={{ fontSize: '11px' }}>
                          <i className={`bi ${typeInfo.icon} me-1`}></i>
                          {typeInfo.label}
                        </span>
                      </td>
                      <td className="text-center">
                        <span className="badge bg-light text-dark">{materialUnit}</span>
                      </td>
                      <td className="text-center">
                        {editingItem?.id === item.id ? (
                          <div className="d-flex align-items-center justify-content-center gap-1">
                            <input
                              type="number"
                              className="form-control form-control-sm text-center"
                              value={editQuantity}
                              onChange={(e) => setEditQuantity(e.target.value)}
                              style={{ width: '60px', fontSize: '13px' }}
                              min="1"
                              step="1"
                              autoFocus
                            />
                            <div className="btn-group btn-group-sm">
                              <button
                                className="btn btn-success"
                                onClick={handleSaveQuantity}
                                style={{ padding: '2px 6px', fontSize: '11px' }}
                              >
                                <i className="bi bi-check"></i>
                              </button>
                              <button
                                className="btn btn-secondary"
                                onClick={handleCancelEdit}
                                style={{ padding: '2px 6px', fontSize: '11px' }}
                              >
                                <i className="bi bi-x"></i>
                              </button>
                            </div>
                          </div>
                        ) : (
                          <button
                            className="btn btn-outline-primary btn-sm"
                            onClick={() => handleEditQuantity(item)}
                            style={{ minWidth: '50px', fontSize: '13px' }}
                          >
                            {quantity}
                          </button>
                        )}
                      </td>
                      <td className="text-center">
                        <span className="fw-bold text-success">
                          {unitPrice.toLocaleString('en-US')} ÿ±.ÿ≥
                        </span>
                      </td>
                      <td className="text-center">
                        <span className="text-muted small">{supplier}</span>
                      </td>
                      <td className="text-center">
                        <div>
                          <span className="fw-bold text-primary fs-6">
                            {totalPrice.toLocaleString('en-US')} ÿ±.ÿ≥
                          </span>
                          <div>
                            <small className="text-muted">
                              {quantity} √ó {unitPrice.toLocaleString('en-US')}
                            </small>
                          </div>
                        </div>
                      </td>
                      <td className="text-center">
                        <div className="btn-group btn-group-sm">
                          <button
                            className="btn btn-outline-primary"
                            onClick={() => handleEditQuantity(item)}
                            title="ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÉŸÖŸäÿ©"
                            disabled={loading || editingItem}
                            style={{ fontSize: '12px' }}
                          >
                            <i className="bi bi-pencil"></i>
                          </button>
                          <button
                            className="btn btn-outline-danger"
                            onClick={() => handleDeleteClick(item)}
                            title="ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸÜÿØ"
                            disabled={loading}
                            style={{ fontSize: '12px' }}
                          >
                            <i className="bi bi-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
              
              {/* Footer with totals */}
              <tfoot className="table-light">
                <tr>
                  <td colSpan="8" className="text-end fw-bold">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÜÿßŸÇÿµÿ©:</td>
                  <td className="text-center">
                    <span className="fw-bold text-primary fs-5">
                      {totals.totalPrice.toLocaleString('en-US')} ÿ±.ÿ≥
                    </span>
                  </td>
                  <td className="text-center">
                    <span className="badge bg-info">
                      {totals.totalQuantity} ŸÇÿ∑ÿπÿ©
                    </span>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        )}
      </div>

      {/* Custom Alert */}
      <CustomAlert
        show={alertConfig.show}
        onClose={closeAlert}
        title={alertConfig.title}
        message={alertConfig.message}
        type={alertConfig.type}
        onConfirm={alertConfig.onConfirm}
        confirmText={alertConfig.confirmText}
        cancelText={alertConfig.cancelText}
        showCancel={alertConfig.showCancel}
      />
    </div>
  );
};

// Export both the component and a method to add items externally
export { TenderItemsFirebaseService };
export default TenderItemsListFirebase;